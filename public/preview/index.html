<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reactプレビュー</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom": "https://esm.sh/react-dom@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "jotai": "https://esm.sh/jotai@2.0.0",
          "react-router-dom": "https://esm.sh/react-router-dom@6.8.0"
        }
      }
    </script>
    <!-- Babel Standaloneを追加 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      import React from "react";
      import { createRoot } from "react-dom/client";

      let rootInstance = null;

      // 親ページからのメッセージを受け取る
      window.addEventListener("message", async (event) => {
        if (event.data.type === "CODE_UPDATE") {
          try {
            const code = event.data.code;

            // Babelでコードを変換
            const transformed = Babel.transform(code, {
              presets: ["react", "typescript"],
              filename: "App.tsx",
              sourceType: "module",
            }).code;

            // 動的にモジュールを作成
            const blob = new Blob([transformed], {
              type: "application/javascript",
            });
            const url = URL.createObjectURL(blob);

            // モジュールをインポート
            const module = await import(url);
            const App = module.default;

            if (!App) {
              throw new Error(
                "App component not found (default export missing)"
              );
            }

            // レンダリング
            if (!rootInstance) {
              rootInstance = createRoot(document.getElementById("root"));
            }
            rootInstance.render(React.createElement(App));

            // 使用後URLを解放
            URL.revokeObjectURL(url);

            // コンポーネントがロードされたことをコンソールに表示
            console.log("Reactコンポーネントがロードされました");
          } catch (error) {
            console.error("Error rendering component:", error);
            document.getElementById("root").innerHTML = `
              <div style="color: red; padding: 16px; border: 1px solid #f88; background-color: #fee; border-radius: 4px; font-size: 13px; margin: 16px;">
                <h2>エラーが発生しました</h2>
                <p>${error.message}</p>
                <pre style="overflow: auto; background: #f8f8f8; padding: 10px; border-radius: 4px;">${
                  error.stack || ""
                }</pre>
              </div>
            `;
          }
        }
      });
    </script>
  </body>
</html>
